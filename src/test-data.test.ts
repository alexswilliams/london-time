// generated with `cal 2025` or similar

const year1900CalOutput = `
                            1900
      January               February               March          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
    1  2  3  4  5  6               1  2  3               1  2  3  
 7  8  9 10 11 12 13   4  5  6  7  8  9 10   4  5  6  7  8  9 10  
14 15 16 17 18 19 20  11 12 13 14 15 16 17  11 12 13 14 15 16 17  
21 22 23 24 25 26 27  18 19 20 21 22 23 24  18 19 20 21 22 23 24  
28 29 30 31           25 26 27 28           25 26 27 28 29 30 31  
                                                                  

       April                  May                   June          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
 1  2  3  4  5  6  7         1  2  3  4  5                  1  2  
 8  9 10 11 12 13 14   6  7  8  9 10 11 12   3  4  5  6  7  8  9  
15 16 17 18 19 20 21  13 14 15 16 17 18 19  10 11 12 13 14 15 16  
22 23 24 25 26 27 28  20 21 22 23 24 25 26  17 18 19 20 21 22 23  
29 30                 27 28 29 30 31        24 25 26 27 28 29 30  
                                                                  

        July                 August              September        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
 1  2  3  4  5  6  7            1  2  3  4                     1  
 8  9 10 11 12 13 14   5  6  7  8  9 10 11   2  3  4  5  6  7  8  
15 16 17 18 19 20 21  12 13 14 15 16 17 18   9 10 11 12 13 14 15  
22 23 24 25 26 27 28  19 20 21 22 23 24 25  16 17 18 19 20 21 22  
29 30 31              26 27 28 29 30 31     23 24 25 26 27 28 29  
                                            30                    

      October               November              December        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
    1  2  3  4  5  6               1  2  3                     1  
 7  8  9 10 11 12 13   4  5  6  7  8  9 10   2  3  4  5  6  7  8  
14 15 16 17 18 19 20  11 12 13 14 15 16 17   9 10 11 12 13 14 15  
21 22 23 24 25 26 27  18 19 20 21 22 23 24  16 17 18 19 20 21 22  
28 29 30 31           25 26 27 28 29 30     23 24 25 26 27 28 29  
                                            30 31 
`
const year2000CalOutput = `
                            2000
      January               February               March          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
                   1         1  2  3  4  5            1  2  3  4  
 2  3  4  5  6  7  8   6  7  8  9 10 11 12   5  6  7  8  9 10 11  
 9 10 11 12 13 14 15  13 14 15 16 17 18 19  12 13 14 15 16 17 18  
16 17 18 19 20 21 22  20 21 22 23 24 25 26  19 20 21 22 23 24 25  
23 24 25 26 27 28 29  27 28 29              26 27 28 29 30 31     
30 31                                                             

       April                  May                   June          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
                   1      1  2  3  4  5  6               1  2  3  
 2  3  4  5  6  7  8   7  8  9 10 11 12 13   4  5  6  7  8  9 10  
 9 10 11 12 13 14 15  14 15 16 17 18 19 20  11 12 13 14 15 16 17  
16 17 18 19 20 21 22  21 22 23 24 25 26 27  18 19 20 21 22 23 24  
23 24 25 26 27 28 29  28 29 30 31           25 26 27 28 29 30     
30                                                                

        July                 August              September        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
                   1         1  2  3  4  5                  1  2  
 2  3  4  5  6  7  8   6  7  8  9 10 11 12   3  4  5  6  7  8  9  
 9 10 11 12 13 14 15  13 14 15 16 17 18 19  10 11 12 13 14 15 16  
16 17 18 19 20 21 22  20 21 22 23 24 25 26  17 18 19 20 21 22 23  
23 24 25 26 27 28 29  27 28 29 30 31        24 25 26 27 28 29 30  
30 31                                                             

      October               November              December        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
 1  2  3  4  5  6  7            1  2  3  4                  1  2  
 8  9 10 11 12 13 14   5  6  7  8  9 10 11   3  4  5  6  7  8  9  
15 16 17 18 19 20 21  12 13 14 15 16 17 18  10 11 12 13 14 15 16  
22 23 24 25 26 27 28  19 20 21 22 23 24 25  17 18 19 20 21 22 23  
29 30 31              26 27 28 29 30        24 25 26 27 28 29 30  
                                            31         
`
const year2020CalOutput = `
                            2020
      January               February               March          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
          1  2  3  4                     1   1  2  3  4  5  6  7  
 5  6  7  8  9 10 11   2  3  4  5  6  7  8   8  9 10 11 12 13 14  
12 13 14 15 16 17 18   9 10 11 12 13 14 15  15 16 17 18 19 20 21  
19 20 21 22 23 24 25  16 17 18 19 20 21 22  22 23 24 25 26 27 28  
26 27 28 29 30 31     23 24 25 26 27 28 29  29 30 31              
                                                                  

       April                  May                   June          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
          1  2  3  4                  1  2      1  2  3  4  5  6  
 5  6  7  8  9 10 11   3  4  5  6  7  8  9   7  8  9 10 11 12 13  
12 13 14 15 16 17 18  10 11 12 13 14 15 16  14 15 16 17 18 19 20  
19 20 21 22 23 24 25  17 18 19 20 21 22 23  21 22 23 24 25 26 27  
26 27 28 29 30        24 25 26 27 28 29 30  28 29 30              
                      31                                          

        July                 August              September        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
          1  2  3  4                     1         1  2  3  4  5  
 5  6  7  8  9 10 11   2  3  4  5  6  7  8   6  7  8  9 10 11 12  
12 13 14 15 16 17 18   9 10 11 12 13 14 15  13 14 15 16 17 18 19  
19 20 21 22 23 24 25  16 17 18 19 20 21 22  20 21 22 23 24 25 26  
26 27 28 29 30 31     23 24 25 26 27 28 29  27 28 29 30           
                      30 31                                       

      October               November              December        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
             1  2  3   1  2  3  4  5  6  7         1  2  3  4  5  
 4  5  6  7  8  9 10   8  9 10 11 12 13 14   6  7  8  9 10 11 12  
11 12 13 14 15 16 17  15 16 17 18 19 20 21  13 14 15 16 17 18 19  
18 19 20 21 22 23 24  22 23 24 25 26 27 28  20 21 22 23 24 25 26  
25 26 27 28 29 30 31  29 30                 27 28 29 30 31       
`
const year2025CalOutput = `
                            2025
      January               February               March          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
          1  2  3  4                     1                     1  
 5  6  7  8  9 10 11   2  3  4  5  6  7  8   2  3  4  5  6  7  8  
12 13 14 15 16 17 18   9 10 11 12 13 14 15   9 10 11 12 13 14 15  
19 20 21 22 23 24 25  16 17 18 19 20 21 22  16 17 18 19 20 21 22  
26 27 28 29 30 31     23 24 25 26 27 28     23 24 25 26 27 28 29  
                                            30 31                 

       April                  May                   June          
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
       1  2  3  4  5               1  2  3   1  2  3  4  5  6  7  
 6  7  8  9 10 11 12   4  5  6  7  8  9 10   8  9 10 11 12 13 14  
13 14 15 16 17 18 19  11 12 13 14 15 16 17  15 16 17 18 19 20 21  
20 21 22 23 24 25 26  18 19 20 21 22 23 24  22 23 24 25 26 27 28  
27 28 29 30           25 26 27 28 29 30 31  29 30                 
                                                                  

        July                 August              September        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
       1  2  3  4  5                  1  2      1  2  3  4  5  6  
 6  7  8  9 10 11 12   3  4  5  6  7  8  9   7  8  9 10 11 12 13  
13 14 15 16 17 18 19  10 11 12 13 14 15 16  14 15 16 17 18 19 20  
20 21 22 23 24 25 26  17 18 19 20 21 22 23  21 22 23 24 25 26 27  
27 28 29 30 31        24 25 26 27 28 29 30  28 29 30              
                      31                                          

      October               November              December        
Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  Su Mo Tu We Th Fr Sa  
          1  2  3  4                     1      1  2  3  4  5  6  
 5  6  7  8  9 10 11   2  3  4  5  6  7  8   7  8  9 10 11 12 13  
12 13 14 15 16 17 18   9 10 11 12 13 14 15  14 15 16 17 18 19 20  
19 20 21 22 23 24 25  16 17 18 19 20 21 22  21 22 23 24 25 26 27  
26 27 28 29 30 31     23 24 25 26 27 28 29  28 29 30 31           
                      30                                          
`

export const datesInYear1900: DateToDayRecord[] = parseCalYear(year1900CalOutput)
export const datesInYear2000: DateToDayRecord[] = parseCalYear(year2000CalOutput)
export const datesInYear2020: DateToDayRecord[] = parseCalYear(year2020CalOutput)
export const datesInYear2025: DateToDayRecord[] = parseCalYear(year2025CalOutput)

type DayOfWeek = 'Su' | 'Mo' | 'Tu' | 'We' | 'Th' | 'Fr' | 'Sa'
interface DateToDayRecord {
  date: string
  dayOfWeek: DayOfWeek
}

function parseCalYear(fullText: string): DateToDayRecord[] {
  const lines = fullText.trim().split('\n')
  const year = lines[0]!.trim()

  const blankLineIndexes = lines.map((line, index) => (line.trim() === '' ? index : 0)).filter(it => it > 0)
  blankLineIndexes.unshift(0)
  blankLineIndexes.push(lines.length)
  const monthRows = zipWithNext(blankLineIndexes)
    .filter(([from, to]) => to - from > 2)
    .map(([from, to]) => lines.slice(from + 1, to))

  const months = monthRows.flatMap(chunk => {
    const dayRow = chunk.find(it => it.startsWith('Su Mo Tu'))!
    const startIndexes = Array.from(dayRow.matchAll(/Su Mo Tu/g)).map(it => it.index)
    startIndexes.push(dayRow.length)
    return zipWithNext(startIndexes).map(([from, to]) => chunk.map(line => line.slice(from, to - 2)).filter(it => it.trim().length > 0))
  })

  return months.flatMap(it => parseCalMonth(it, year))
}

function parseCalMonth(monthLines: string[], yearOverride: string): DateToDayRecord[] {
  const monthRow = monthLines[0]!.trim()
  const monthName = monthRow.split(' ')[0]!
  const monthNumber = {
    January: '01',
    February: '02',
    March: '03',
    April: '04',
    May: '05',
    June: '06',
    July: '07',
    August: '08',
    September: '09',
    October: '10',
    November: '11',
    December: '12',
  }[monthName]!
  const yearFromText = monthRow.split(' ')[1]
  const year = yearFromText ? yearFromText : yearOverride
  const yearMonth = `${year}-${monthNumber}`

  const dayNumbers = monthLines.slice(2)
  const dates = dayNumbers.flatMap(line =>
    [
      { dayOfWeek: 'Su', day: line.slice(0, 2).trim() },
      { dayOfWeek: 'Mo', day: line.slice(3, 5).trim() },
      { dayOfWeek: 'Tu', day: line.slice(6, 8).trim() },
      { dayOfWeek: 'We', day: line.slice(9, 11).trim() },
      { dayOfWeek: 'Th', day: line.slice(12, 14).trim() },
      { dayOfWeek: 'Fr', day: line.slice(15, 17).trim() },
      { dayOfWeek: 'Sa', day: line.slice(18, 20).trim() },
    ]
      .filter(it => it.day !== '')
      .map(it => ({ dayOfWeek: it.dayOfWeek as DayOfWeek, date: `${yearMonth}-${zeroPad(it.day)}` })),
  )
  return dates
}

function zipWithNext<T>(arr: T[]): [T, T][] {
  if (arr.length < 2) return []
  const result: [T, T][] = []
  let last = arr[0]!
  for (let i = 1; i < arr.length; i++) {
    result.push([last, arr[i]!])
    last = arr[i]!
  }
  return result
}

function zeroPad(day: string): string {
  return day.length === 1 ? `0${day}` : day
}

describe('Test Data sanity checks', () => {
  test('All dates are accounted for', () => {
    expect(datesInYear2000).toHaveLength(366)
    expect(datesInYear1900).toHaveLength(365)
    expect(datesInYear2020).toHaveLength(366)
    expect(datesInYear2025).toHaveLength(365)
  })

  test('All dates are well-shaped', () => {
    for (const date of datesInYear1900.map(it => it.date)) {
      expect(date).toMatch(/1900-(0[1-9]|10|11|12)-(0[1-9]|1[0-9]|2[0-9]|30|31)/)
    }
    for (const date of datesInYear2000.map(it => it.date)) {
      expect(date).toMatch(/2000-(0[1-9]|10|11|12)-(0[1-9]|1[0-9]|2[0-9]|30|31)/)
    }
    for (const date of datesInYear2020.map(it => it.date)) {
      expect(date).toMatch(/2020-(0[1-9]|10|11|12)-(0[1-9]|1[0-9]|2[0-9]|30|31)/)
    }
    for (const date of datesInYear2025.map(it => it.date)) {
      expect(date).toMatch(/2025-(0[1-9]|10|11|12)-(0[1-9]|1[0-9]|2[0-9]|30|31)/)
    }
  })
})
